<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MORGBY.OS | Tactical Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .recording-dot { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans select-none overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const Icon = ({ name, size = 18, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    lucide.createIcons({
                        attrs: { 'stroke-width': 2, size, class: className },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size, className]);
            return <i data-lucide={name} ref={iconRef}></i>;
        };

        const TF_JS = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0';
        const COCO_SSD = 'https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2';

        const loadScript = (src) => new Promise((res) => {
            if (document.querySelector(`script[src="${src}"]`)) return res();
            const s = document.createElement('script');
            s.src = src; s.onload = res; document.body.appendChild(s);
        });

        function App() {
            const [activeTab, setActiveTab] = useState('monitor');
            const [isMonitoring, setIsMonitoring] = useState(false);
            const [isModelLoaded, setIsModelLoaded] = useState(false);
            const [logs, setLogs] = useState([]);
            const [queueCount, setQueueCount] = useState(0);
            const [isBlackout, setIsBlackout] = useState(false);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [isFlashActive, setIsFlashActive] = useState(false);

            const [config, setConfig] = useState(() => {
                const saved = localStorage.getItem('morgby_final_cfg');
                return saved ? JSON.parse(saved) : {
                    botToken: '', chatId: '', interval: 15, personOnly: true, useFlash: false
                };
            });

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);
            const netRef = useRef(null);
            const dbRef = useRef(null);
            const lastOffset = useRef(0);
            const wakeLockRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('morgby_final_cfg', JSON.stringify(config));
            }, [config]);

            const addLog = useCallback((msg, type = 'info') => {
                const time = new Date().toLocaleTimeString();
                setLogs(prev => [{ time, msg, type }, ...prev].slice(0, 50));
            }, []);

            const requestWakeLock = async () => {
                if ('wakeLock' in navigator) {
                    try {
                        wakeLockRef.current = await navigator.wakeLock.request('screen');
                        addLog('Wake Lock: Active', 'success');
                    } catch (err) {
                        addLog('Wake Lock: Failed', 'error');
                    }
                }
            };

            const releaseWakeLock = () => {
                if (wakeLockRef.current) {
                    wakeLockRef.current.release();
                    wakeLockRef.current = null;
                }
            };

            useEffect(() => {
                const req = indexedDB.open('MorgbyFinalDB', 1);
                req.onupgradeneeded = (e) => e.target.result.createObjectStore('queue', { keyPath: 'id', autoIncrement: true });
                req.onsuccess = (e) => {
                    dbRef.current = e.target.result;
                    refreshQueue();
                    loadAI();
                };
                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));
                
                const handleVisibility = () => {
                    if (document.visibilityState === 'visible' && isMonitoring) {
                        requestWakeLock();
                    }
                };
                document.addEventListener('visibilitychange', handleVisibility);

                return () => {
                    releaseWakeLock();
                    document.removeEventListener('visibilitychange', handleVisibility);
                };
            }, [isMonitoring]);

            const loadAI = async () => {
                addLog('Booting AI Vision Core...');
                try {
                    await loadScript(TF_JS);
                    await loadScript(COCO_SSD);
                    if (window.cocoSsd) {
                        netRef.current = await cocoSsd.load();
                        setIsModelLoaded(true);
                        addLog('Neural Network Online', 'success');
                    }
                } catch (e) {
                    addLog('AI Load Failed', 'error');
                }
            };

            const refreshQueue = () => {
                if (!dbRef.current) return;
                const tx = dbRef.current.transaction('queue', 'readonly');
                const req = tx.objectStore('queue').getAll();
                req.onsuccess = () => setQueueCount(req.result.length);
            };

            const clearStorage = () => {
                if (!dbRef.current) return;
                const tx = dbRef.current.transaction('queue', 'readwrite');
                tx.objectStore('queue').clear();
                tx.oncomplete = () => {
                    refreshQueue();
                    addLog('Queue Wiped', 'error');
                };
            };

            const toggleFlash = async (force) => {
                const track = streamRef.current?.getVideoTracks()[0];
                if (!track) return;
                try {
                    const capabilities = track.getCapabilities();
                    if (capabilities.torch) {
                        const newState = force !== undefined ? force : !isFlashActive;
                        await track.applyConstraints({ advanced: [{ torch: newState }] });
                        setIsFlashActive(newState);
                    }
                } catch (e) {}
            };

            const capture = async (reason = 'Manual') => {
                if (!videoRef.current || !dbRef.current) return;
                
                if (config.useFlash) {
                    await toggleFlash(true);
                    await new Promise(r => setTimeout(r, 600));
                }

                if (config.personOnly && netRef.current) {
                    const predictions = await netRef.current.detect(videoRef.current);
                    const hasPerson = predictions.some(p => p.class === 'person');
                    if (!hasPerson && reason === 'Auto') {
                        if (config.useFlash) await toggleFlash(false);
                        return;
                    }
                }

                const canvas = canvasRef.current;
                canvas.width = videoRef.current.videoWidth;
                canvas.height = videoRef.current.videoHeight;
                canvas.getContext('2d', { alpha: false }).drawImage(videoRef.current, 0, 0);

                if (config.useFlash) await toggleFlash(false);

                canvas.toBlob(blob => {
                    const tx = dbRef.current.transaction('queue', 'readwrite');
                    tx.objectStore('queue').add({
                        blob,
                        caption: `üö® MORGBY SYSTEM ALERT\nReason: ${reason}\nDevice: ${navigator.platform}\nTime: ${new Date().toLocaleString()}`,
                        timestamp: Date.now()
                    });
                    tx.oncomplete = () => {
                        refreshQueue();
                        addLog(`Captured: ${reason}`, 'success');
                        sync();
                    };
                }, 'image/jpeg', 0.7);
            };

            const sync = async () => {
                if (!isOnline || !config.botToken || !dbRef.current) return;
                const tx = dbRef.current.transaction('queue', 'readonly');
                const items = await new Promise(r => tx.objectStore('queue').getAll().onsuccess = e => r(e.target.result));
                
                for (const item of items) {
                    const formData = new FormData();
                    formData.append('chat_id', config.chatId);
                    formData.append('caption', item.caption);
                    formData.append('photo', item.blob, 'morgby.jpg');

                    try {
                        const res = await fetch(`https://api.telegram.org/bot${config.botToken}/sendPhoto`, { method: 'POST', body: formData });
                        if (res.ok) {
                            const delTx = dbRef.current.transaction('queue', 'readwrite');
                            delTx.objectStore('queue').delete(item.id);
                            delTx.oncomplete = refreshQueue;
                        } else { break; }
                    } catch (err) { break; }
                }
            };

            const toggleMonitor = async () => {
                if (isMonitoring) {
                    setIsMonitoring(false);
                    streamRef.current?.getTracks().forEach(t => t.stop());
                    setIsFlashActive(false);
                    releaseWakeLock();
                    addLog('System Standby');
                } else {
                    try {
                        const s = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: 'environment', width: { ideal: 1280 } },
                            audio: false
                        });
                        videoRef.current.srcObject = s;
                        streamRef.current = s;
                        setIsMonitoring(true);
                        requestWakeLock();
                        addLog('System Online', 'success');
                        capture('Initialization');
                    } catch (e) { 
                        addLog('Camera Error', 'error'); 
                    }
                }
            };

            useEffect(() => {
                if (!isMonitoring) return;
                const timer = setInterval(() => capture('Auto'), config.interval * 60000);
                const poll = setInterval(async () => {
                    if (!isOnline || !config.botToken) return;
                    try {
                        const r = await fetch(`https://api.telegram.org/bot${config.botToken}/getUpdates?offset=${lastOffset.current + 1}&timeout=0`);
                        const d = await r.json();
                        if (d.ok && d.result.length > 0) {
                            lastOffset.current = d.result[d.result.length - 1].update_id;
                            d.result.forEach(u => {
                                const cmd = u.message?.text?.toLowerCase();
                                if (cmd === '/photo') capture('Remote Trigger');
                                if (cmd === '/flash_on') toggleFlash(true);
                                if (cmd === '/flash_off') toggleFlash(false);
                            });
                        }
                    } catch(e) {}
                }, 4000);
                return () => { clearInterval(timer); clearInterval(poll); };
            }, [isMonitoring, isOnline, config, queueCount, isModelLoaded]);

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-slate-950 relative border-x border-slate-900 overflow-hidden">
                    {isBlackout && (
                        <div onClick={() => setIsBlackout(false)} className="absolute inset-0 bg-black z-[100] flex items-center justify-center">
                            <div className="w-1 h-1 bg-white/10 rounded-full" />
                        </div>
                    )}
                    
                    <header className="p-4 border-b border-slate-900 flex justify-between items-center bg-slate-950/80 backdrop-blur-md sticky top-0 z-10">
                        <div className="flex items-center gap-2">
                            <div className={`w-2 h-2 rounded-full ${isMonitoring ? 'bg-red-500 recording-dot' : 'bg-slate-700'}`} />
                            <h1 className="font-black tracking-tighter text-lg uppercase">Morgby<span className="text-red-600">.</span>OS</h1>
                        </div>
                        <div className="flex gap-4 items-center">
                            <button onClick={() => setIsBlackout(true)} className="text-slate-500 hover:text-white">
                                <Icon name="eye-off" size={18} />
                            </button>
                            <Icon name="wifi" className={isOnline ? "text-green-500" : "text-red-600"} size={18} />
                        </div>
                    </header>

                    <nav className="flex gap-6 px-4 py-3 border-b border-slate-900 text-[10px] font-black uppercase tracking-widest overflow-x-auto whitespace-nowrap scrollbar-hide">
                        {['monitor', 'config', 'manual', 'logs'].map(t => (
                            <button key={t} onClick={() => setActiveTab(t)} className={activeTab === t ? "text-blue-500 border-b-2 border-blue-500 pb-1" : "text-slate-600 pb-1"}>{t}</button>
                        ))}
                    </nav>

                    <main className="flex-1 overflow-y-auto p-4 space-y-6">
                        {activeTab === 'monitor' && (
                            <div className="space-y-4 animate-in fade-in duration-500">
                                <div className="aspect-video bg-black rounded-2xl border border-slate-900 overflow-hidden relative">
                                    <video ref={videoRef} autoPlay playsInline muted className={`w-full h-full object-cover transition-opacity duration-1000 ${isMonitoring ? 'opacity-80' : 'opacity-10'}`} />
                                    <canvas ref={canvasRef} className="hidden" />
                                </div>
                                
                                <button onClick={toggleMonitor} className={`w-full py-5 rounded-2xl font-black text-xs tracking-[0.2em] flex items-center justify-center gap-3 transition-all ${isMonitoring ? 'bg-red-600/10 text-red-500 border border-red-900/50' : 'bg-blue-600 text-white shadow-lg shadow-blue-900/40'}`}>
                                    <Icon name={isMonitoring ? "power" : "shield-check"} />
                                    {isMonitoring ? 'DISARM SYSTEM' : 'INITIALIZE PROTOCOL'}
                                </button>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-slate-900/30 p-4 rounded-2xl border border-slate-900/50 text-center">
                                        <p className="text-[9px] text-slate-500 font-bold uppercase mb-1 text-center">Queue</p>
                                        <p className="text-xl font-black">{queueCount}</p>
                                    </div>
                                    <div className="bg-slate-900/30 p-4 rounded-2xl border border-slate-900/50 text-center">
                                        <p className="text-[9px] text-slate-500 font-bold uppercase mb-1 text-center">AI Vision</p>
                                        <p className={`text-xl font-black ${isModelLoaded ? 'text-blue-500' : 'text-slate-700'}`}>{isModelLoaded ? 'READY' : 'OFFLINE'}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'config' && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <div className="bg-slate-900/30 p-5 rounded-2xl border border-slate-900/50 space-y-4">
                                    <h3 className="text-[10px] font-black text-blue-500 uppercase tracking-widest">Telegram API</h3>
                                    <div>
                                        <label className="text-[9px] text-slate-600 font-bold uppercase block mb-1">Bot Token</label>
                                        <input type="password" value={config.botToken} onChange={e => setConfig({...config, botToken: e.target.value})} className="w-full bg-slate-950 border border-slate-800 p-3 rounded-xl text-sm outline-none" placeholder="123456:ABC..." />
                                    </div>
                                    <div>
                                        <label className="text-[9px] text-slate-600 font-bold uppercase block mb-1">Chat ID</label>
                                        <input type="text" value={config.chatId} onChange={e => setConfig({...config, chatId: e.target.value})} className="w-full bg-slate-950 border border-slate-800 p-3 rounded-xl text-sm outline-none" placeholder="987654321" />
                                    </div>
                                </div>
                                <div className="bg-slate-900/30 p-5 rounded-2xl border border-slate-900/50 space-y-5 text-sm">
                                    <h3 className="text-[10px] font-black text-blue-500 uppercase tracking-widest">Logic</h3>
                                    <div className="flex justify-between items-center text-slate-400">
                                        <span>Use Flash Strobe</span>
                                        <input type="checkbox" checked={config.useFlash} onChange={e => setConfig({...config, useFlash: e.target.checked})} className="w-5 h-5 accent-blue-600" />
                                    </div>
                                    <div className="flex justify-between items-center text-slate-400">
                                        <span>Person Only Mode</span>
                                        <input type="checkbox" checked={config.personOnly} onChange={e => setConfig({...config, personOnly: e.target.checked})} className="w-5 h-5 accent-blue-600" />
                                    </div>
                                    <div>
                                        <label className="text-[9px] text-slate-600 font-bold uppercase block mb-2">Capture Interval: {config.interval}m</label>
                                        <input type="range" min="1" max="60" value={config.interval} onChange={e => setConfig({...config, interval: parseInt(e.target.value)})} className="w-full h-1.5 bg-slate-800 rounded-lg appearance-none" />
                                    </div>
                                </div>
                                <button onClick={clearStorage} className="w-full py-3 text-[10px] font-black text-red-500 border border-red-900/30 rounded-xl uppercase">Wipe Local Queue</button>
                            </div>
                        )}

                        {activeTab === 'manual' && (
                            <div className="space-y-6 animate-in fade-in duration-300 pb-10">
                                <section className="space-y-3 bg-blue-950/10 p-4 rounded-2xl border border-blue-900/20">
                                    <h3 className="text-blue-500 font-black uppercase text-[10px] tracking-widest flex items-center gap-2">
                                        <Icon name="info" size={14} /> Legal & Privacy Disclaimer
                                    </h3>
                                    <div className="text-[11px] text-slate-400 space-y-2 leading-relaxed">
                                        <p className="border-l-2 border-blue-600 pl-2">
                                            <b className="text-white">PURPOSE:</b> This application is intended for <b className="text-blue-400">personal surveillance</b> use only (e.g., a low-powered home security device, pet monitor, or entrance observer).
                                        </p>
                                        <p className="text-red-400 font-bold">
                                            ‚ö†Ô∏è PROHIBITED USE: This tool must NOT be used for any criminal activities, unauthorized eavesdropping, or any form of illegal surveillance.
                                        </p>
                                        <p className="border-l-2 border-green-600 pl-2">
                                            <b className="text-white">DATA PRIVACY:</b> All captures and logs are <b className="text-green-400">stored locally</b> on this device using IndexedDB. No data is transmitted to external servers, except for your encrypted Telegram bot communication.
                                        </p>
                                    </div>
                                </section>

                                <section className="space-y-3">
                                    <h3 className="text-slate-500 font-black uppercase text-[10px] tracking-widest border-b border-slate-900 pb-1">1. Quick Setup</h3>
                                    <div className="text-[11px] text-slate-400 space-y-2 leading-relaxed">
                                        <p><b className="text-white">STEP 01:</b> Message <span className="text-blue-400">@BotFather</span> on Telegram to create a bot and get a <b>Token</b>.</p>
                                        <p><b className="text-white">STEP 02:</b> Message <span className="text-blue-400">@userinfobot</span> to find your <b>Chat ID</b>.</p>
                                        <p><b className="text-white">STEP 03:</b> Paste both into the <b>CONFIG</b> tab.</p>
                                        <p><b className="text-white">STEP 04:</b> Press <b>INITIALIZE PROTOCOL</b> and grant camera access.</p>
                                    </div>
                                </section>

                                <section className="space-y-3">
                                    <h3 className="text-slate-500 font-black uppercase text-[10px] tracking-widest border-b border-slate-900 pb-1">2. Features</h3>
                                    <div className="grid grid-cols-1 gap-2">
                                        {[
                                            { t: 'Universal Compatibility', d: 'Works on iOS (Safari) and Android (Chrome) with persistent Wake Lock.' },
                                            { t: 'AI Person Filtering', d: 'Ignores movement from shadows or pets to save storage/bandwidth.' },
                                            { t: 'Offline Syncing', d: 'Queue images locally during WiFi outages and sync once back online.' },
                                            { t: 'Stealth Mode', d: 'Blacks out screen while maintaining active camera feed.' }
                                        ].map(f => (
                                            <div key={f.t} className="bg-slate-900/20 p-3 rounded-lg border border-slate-900">
                                                <p className="text-[10px] font-black text-slate-200 uppercase">{f.t}</p>
                                                <p className="text-[10px] text-slate-500">{f.d}</p>
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                <section className="space-y-3 bg-red-950/20 p-4 rounded-2xl border border-red-900/30">
                                    <h3 className="text-red-500 font-black uppercase text-[10px] tracking-widest flex items-center gap-2">
                                        <Icon name="battery-charging" size={14} /> Battery Management Tips
                                    </h3>
                                    <div className="text-[11px] text-slate-400 space-y-3 leading-relaxed">
                                        <p><b className="text-white underline">Preventing Battery Bloat:</b> Continuous 100% charging leads to gas buildup and swelling. Use a <b>Smart Plug</b> to cycle power (Charge to 80%, discharge to 20%).</p>
                                        <p><b className="text-white underline">The "Dummy Battery" Approach:</b> For permanent installations, if your device supports it, remove the physical battery and power the device via a high-quality 5V/2A wall adapter directly.</p>
                                        <p><b className="text-white underline">Heat Dissipation:</b> AI Vision consumes CPU. Ensure the device is mounted in a ventilated area. If the screen begins to lift, DISCONTINUE USE immediately.</p>
                                    </div>
                                </section>
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="bg-slate-950 border border-slate-900 rounded-2xl p-4 font-mono text-[9px] min-h-[300px] overflow-y-auto space-y-2">
                                {logs.map((l, i) => (
                                    <div key={i} className={`flex gap-3 ${l.type === 'error' ? 'text-red-400' : 'text-slate-500'}`}>
                                        <span className="opacity-30">[{l.time}]</span>
                                        <span className={l.type === 'success' ? 'text-green-500' : ''}>{l.msg}</span>
                                    </div>
                                ))}
                                {logs.length === 0 && <p className="text-center text-slate-800 mt-10">NO LOGS RECORDED</p>}
                            </div>
                        )}
                    </main>

                    <footer className="p-4 bg-slate-950 text-[9px] text-slate-700 uppercase tracking-[0.2em] text-center border-t border-slate-900/50">
                        MORGBY v2.5 FINAL ‚Ä¢ ENCRYPTED SESSION
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
