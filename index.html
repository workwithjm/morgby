<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MORGBY.OS | Tactical Suite</title>
    
    <!-- Tailwind for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --bg: #020617; --text: #f8fafc; --accent: #2563eb; --danger: #dc2626; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 0; overflow: hidden; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- CONSTANTS ---
        const TF_SCRIPT = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0';
        const COCO_SCRIPT = 'https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2';

        // --- ICON COMPONENT HELPER ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    // Use the built-in createIcons method to inject icons into data-lucide attributes
                    window.lucide.createIcons({
                        attrs: {
                            strokeWidth: 2,
                            width: size,
                            height: size,
                            class: className
                        },
                        nameAttr: 'data-lucide',
                        icons: window.lucide.icons
                    });
                }
            }, [name, size, className]);

            return <i ref={iconRef} data-lucide={name.toLowerCase()}></i>;
        };

        const App = () => {
            // --- STATE ---
            const [activeTab, setActiveTab] = useState('monitor'); 
            const [isMonitoring, setIsMonitoring] = useState(false);
            const [isModelLoaded, setIsModelLoaded] = useState(false);
            const [lastCaptureTime, setLastCaptureTime] = useState(null);
            const [logs, setLogs] = useState([]);
            const [queueCount, setQueueCount] = useState(0); 
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [isBlackout, setIsBlackout] = useState(false);
            const [storageUsed, setStorageUsed] = useState(0);
            const [isTestingApi, setIsTestingApi] = useState(false);
            
            const [config, setConfig] = useState({
                botToken: '',
                chatId: '',
                intervalMinutes: 15,
                flashEnabled: false,
                detectPerson: true,
                storageLimitMb: 100,
            });

            // --- REFS ---
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);
            const netRef = useRef(null);
            const intervalRef = useRef(null);
            const pollRef = useRef(null);
            const wakeLockRef = useRef(null);
            const offsetRef = useRef(0);
            const dbRef = useRef(null);

            // --- LOGGING ---
            const addLog = useCallback((msg, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => [{ time: timestamp, msg, type }, ...prev].slice(0, 50));
                console.log(`[${timestamp}] ${type.toUpperCase()}: ${msg}`);
            }, []);

            // --- STORAGE ---
            const initDB = () => {
                return new Promise((resolve) => {
                    const request = indexedDB.open('MorgbyStorage', 1);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    request.onsuccess = (e) => {
                        dbRef.current = e.target.result;
                        updateStats();
                        resolve();
                    };
                });
            };

            const updateStats = () => {
                if (!dbRef.current) return;
                const store = dbRef.current.transaction(['files'], 'readonly').objectStore('files');
                const req = store.getAll();
                req.onsuccess = () => {
                    const items = req.result;
                    const size = items.reduce((acc, curr) => acc + curr.blob.size, 0);
                    setStorageUsed(Number((size / (1024 * 1024)).toFixed(2)));
                    setQueueCount(items.length);
                };
            };

            // --- CAMERA & AI ---
            const loadAI = async () => {
                try {
                    addLog('Loading AI vision...', 'info');
                    const tf = document.createElement('script'); tf.src = TF_SCRIPT; document.head.appendChild(tf);
                    tf.onload = () => {
                        const coco = document.createElement('script'); coco.src = COCO_SCRIPT; document.head.appendChild(coco);
                        coco.onload = async () => {
                            netRef.current = await window.cocoSsd.load();
                            setIsModelLoaded(true);
                            addLog('AI Engine Online', 'success');
                        };
                    };
                } catch (err) { addLog('AI Init Error', 'error'); }
            };

            const startCamera = async () => {
                addLog('Activating Camera...', 'info');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' }, 
                        audio: false 
                    });
                    videoRef.current.srcObject = stream;
                    streamRef.current = stream;
                    if ('wakeLock' in navigator) wakeLockRef.current = await navigator.wakeLock.request('screen');
                    addLog('Camera Stream Active', 'success');
                    return true;
                } catch (err) {
                    addLog(`Camera Error: ${err.message}`, 'error');
                    return false;
                }
            };

            // --- TELEGRAM ---
            const testConnection = async () => {
                if (!config.botToken || !config.chatId) return addLog('Credentials missing', 'error');
                setIsTestingApi(true);
                addLog('Testing Telegram Link...', 'info');
                try {
                    const res = await fetch(`https://api.telegram.org/bot${config.botToken}/getMe`);
                    const data = await res.json();
                    if (data.ok) {
                        addLog(`Connected to @${data.result.username}`, 'success');
                        await fetch(`https://api.telegram.org/bot${config.botToken}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ chat_id: config.chatId, text: "âœ… Morgby.OS Diagnostic: Connection Verified." })
                        });
                    } else addLog(data.description, 'error');
                } catch (err) { addLog('Network Fail', 'error'); }
                setIsTestingApi(false);
            };

            const uploadNext = async () => {
                if (!isOnline || !dbRef.current) return;
                const store = dbRef.current.transaction(['files'], 'readonly').objectStore('files');
                const req = store.getAll();
                req.onsuccess = async () => {
                    const items = req.result;
                    if (items.length === 0) return;
                    
                    const item = items[0];
                    addLog(`Uploading item #${item.id}...`, 'info');
                    const fd = new FormData();
                    fd.append('chat_id', config.chatId);
                    fd.append('photo', item.blob, 'capture.jpg');
                    fd.append('caption', item.caption);

                    try {
                        const res = await fetch(`https://api.telegram.org/bot${config.botToken}/sendPhoto`, { method: 'POST', body: fd });
                        if (res.ok) {
                            const delTx = dbRef.current.transaction(['files'], 'readwrite');
                            delTx.objectStore('files').delete(item.id);
                            delTx.oncomplete = updateStats;
                            addLog('Upload successful', 'success');
                        } else {
                            const ed = await res.json();
                            addLog(`Fail: ${ed.description}`, 'error');
                        }
                    } catch (e) { addLog('Upload exception', 'error'); }
                };
            };

            const pollUpdates = useCallback(async () => {
                if (!isOnline || !isMonitoring || !config.botToken) return;
                try {
                    const res = await fetch(`https://api.telegram.org/bot${config.botToken}/getUpdates?offset=${offsetRef.current + 1}&timeout=5`);
                    const data = await res.json();
                    if (data.ok && data.result.length > 0) {
                        offsetRef.current = data.result[data.result.length - 1].update_id;
                        data.result.forEach(u => {
                            const cmd = u.message?.text?.toLowerCase();
                            if (cmd === '/photo') capture('Remote Request');
                            if (cmd === '/status') {
                                const msg = `STATUS:\nðŸ“¡ Online: ${isOnline}\nðŸ“‚ Storage: ${storageUsed}MB\nâ³ Queue: ${queueCount}`;
                                fetch(`https://api.telegram.org/bot${config.botToken}/sendMessage`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ chat_id: config.chatId, text: msg })
                                });
                            }
                        });
                    }
                } catch (e) {}
            }, [isMonitoring, isOnline, config, storageUsed, queueCount]);

            // --- MAIN LOOP ---
            const capture = async (reason) => {
                if (!videoRef.current) return;
                addLog(`Capture: ${reason}`, 'info');
                
                let detected = false;
                if (config.detectPerson && netRef.current) {
                    const preds = await netRef.current.detect(videoRef.current);
                    detected = preds.some(p => p.class === 'person');
                    if (!detected && reason === 'Scheduled') {
                        addLog('No person detected. Skip.', 'info');
                        return;
                    }
                }

                const canvas = canvasRef.current;
                canvas.width = videoRef.current.videoWidth;
                canvas.height = videoRef.current.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoRef.current, 0, 0);
                
                ctx.fillStyle = 'red';
                ctx.font = '20px monospace';
                ctx.fillText(`MORGBY | ${new Date().toLocaleString()} | ${reason}`, 10, 30);

                canvas.toBlob((blob) => {
                    const tx = dbRef.current.transaction(['files'], 'readwrite');
                    tx.objectStore('files').add({ 
                        blob, 
                        caption: `Morgby Evidence\n${new Date().toLocaleString()}\nTrigger: ${reason}`, 
                        timestamp: Date.now() 
                    });
                    tx.oncomplete = () => {
                        updateStats();
                        uploadNext();
                    };
                }, 'image/jpeg', 0.8);
                setLastCaptureTime(new Date());
            };

            const toggleMonitor = async () => {
                if (isMonitoring) {
                    setIsMonitoring(false);
                    if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
                    clearInterval(intervalRef.current);
                    clearInterval(pollRef.current);
                    addLog('System Disarmed', 'warning');
                } else {
                    const ok = await startCamera();
                    if (ok) {
                        setIsMonitoring(true);
                        addLog('SYSTEM ARMED', 'success');
                        capture('Initialization');
                        intervalRef.current = setInterval(() => capture('Scheduled'), config.intervalMinutes * 60000);
                        pollRef.current = setInterval(pollUpdates, 5000);
                    }
                }
            };

            useEffect(() => {
                initDB().then(loadAI);
                const up = () => setIsOnline(true);
                const down = () => setIsOnline(false);
                window.addEventListener('online', up);
                window.addEventListener('offline', down);
                return () => {
                    window.removeEventListener('online', up);
                    window.removeEventListener('offline', down);
                };
            }, []);

            return (
                <div className="flex flex-col h-screen bg-slate-950 text-slate-100 font-mono">
                    {isBlackout && <div className="fixed inset-0 bg-black z-50" onClick={() => setIsBlackout(false)}></div>}

                    <header className="p-4 border-b border-white/5 flex justify-between items-center bg-slate-900/50">
                        <h1 className="font-black italic tracking-tighter text-sm flex items-center gap-2">
                            <div className={`w-2 h-2 rounded-full ${isMonitoring ? 'bg-red-500 animate-pulse' : 'bg-slate-700'}`}></div>
                            MORGBY.OS
                        </h1>
                        <div className="flex gap-4 items-center">
                            <button onClick={() => setIsBlackout(true)} className="text-slate-500 hover:text-white"><Icon name="EyeOff" size={16} /></button>
                            <div className="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-800 border border-white/5">
                                {isOnline ? <span className="text-green-500">ONLINE</span> : <span className="text-red-500">OFFLINE</span>}
                            </div>
                        </div>
                    </header>

                    <nav className="flex p-2 bg-slate-900/30 gap-1 border-b border-white/5">
                        {['monitor', 'config', 'logs'].map(t => (
                            <button key={t} onClick={() => setActiveTab(t)} className={`flex-1 py-2 text-[10px] font-black uppercase rounded ${activeTab === t ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>
                                {t}
                            </button>
                        ))}
                    </nav>

                    <main className="flex-1 overflow-y-auto p-4 max-w-xl mx-auto w-full">
                        {activeTab === 'monitor' && (
                            <div className="space-y-4">
                                <div className="aspect-video bg-black rounded-xl overflow-hidden relative border border-white/5">
                                    <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover opacity-60" />
                                    <canvas ref={canvasRef} className="hidden" />
                                    <div className="absolute bottom-2 left-2 flex gap-2">
                                        <div className="bg-blue-600 text-[8px] px-1.5 py-0.5 rounded font-bold">{queueCount} QUEUED</div>
                                        <div className="bg-slate-800 text-[8px] px-1.5 py-0.5 rounded font-bold">{storageUsed} MB</div>
                                    </div>
                                </div>
                                
                                <button onClick={toggleMonitor} className={`w-full py-4 rounded-xl font-black text-sm tracking-widest transition-all ${isMonitoring ? 'bg-red-600 shadow-lg shadow-red-900/20' : 'bg-blue-600 shadow-lg shadow-blue-900/20'}`}>
                                    {isMonitoring ? 'DISARM SYSTEM' : 'ARM TACTICAL SUITE'}
                                </button>

                                <div className="grid grid-cols-2 gap-2">
                                    <div className="bg-slate-900/50 p-4 rounded-xl border border-white/5">
                                        <div className="text-[8px] text-slate-500 uppercase font-black">AI Status</div>
                                        <div className={`text-xs font-bold mt-1 ${isModelLoaded ? 'text-green-500' : 'text-yellow-500 animate-pulse'}`}>
                                            {isModelLoaded ? 'ENGINE READY' : 'LOADING...'}
                                        </div>
                                    </div>
                                    <div className="bg-slate-900/50 p-4 rounded-xl border border-white/5">
                                        <div className="text-[8px] text-slate-500 uppercase font-black">Last Sync</div>
                                        <div className="text-xs font-bold mt-1 text-slate-300">
                                            {lastCaptureTime ? lastCaptureTime.toLocaleTimeString() : '--:--'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'config' && (
                            <div className="space-y-4">
                                <div className="bg-slate-900 p-4 rounded-xl space-y-4 border border-white/5">
                                    <div className="flex justify-between items-center border-b border-white/5 pb-2">
                                        <span className="text-[10px] font-black uppercase text-slate-500">Bot Link</span>
                                        <button onClick={testConnection} disabled={isTestingApi} className="text-[10px] bg-blue-600 px-2 py-1 rounded font-bold disabled:opacity-50">
                                            {isTestingApi ? 'PINGING...' : 'TEST'}
                                        </button>
                                    </div>
                                    <input type="password" placeholder="Bot Token" className="w-full bg-slate-950 border border-white/5 p-2 rounded text-xs" value={config.botToken} onChange={e => setConfig({...config, botToken: e.target.value})} />
                                    <input type="text" placeholder="Chat ID" className="w-full bg-slate-950 border border-white/5 p-2 rounded text-xs" value={config.chatId} onChange={e => setConfig({...config, chatId: e.target.value})} />
                                </div>

                                <div className="bg-slate-900 p-4 rounded-xl space-y-3 border border-white/5">
                                    <div className="flex justify-between text-[11px]">
                                        <span>Interval (Min)</span>
                                        <input type="number" className="w-12 bg-black text-right" value={config.intervalMinutes} onChange={e => setConfig({...config, intervalMinutes: parseInt(e.target.value) || 1})} />
                                    </div>
                                    <div className="flex justify-between text-[11px]">
                                        <span>AI Human Filter</span>
                                        <input type="checkbox" checked={config.detectPerson} onChange={e => setConfig({...config, detectPerson: e.target.checked})} />
                                    </div>
                                </div>
                                <button onClick={() => {
                                    if(confirm('Wipe local evidence cache?')){
                                        const tx = dbRef.current.transaction(['files'], 'readwrite');
                                        tx.objectStore('files').clear();
                                        tx.oncomplete = updateStats;
                                    }
                                }} className="w-full py-2 text-[10px] text-red-500 font-bold border border-red-900/30 rounded">PURGE STORAGE</button>
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="bg-slate-950 border border-white/5 rounded-xl h-[400px] overflow-y-auto p-3 text-[10px] space-y-1">
                                {logs.map((l, i) => (
                                    <div key={i} className="flex gap-2">
                                        <span className="text-slate-600">[{l.time}]</span>
                                        <span className={l.type === 'error' ? 'text-red-400' : l.type === 'success' ? 'text-blue-400' : 'text-slate-400 uppercase'}>
                                            {l.msg}
                                        </span>
                                    </div>
                                ))}
                                {logs.length === 0 && <div className="text-center mt-20 text-slate-800">NO ACTIVE LOGS</div>}
                            </div>
                        )}
                    </main>

                    <footer className="p-4 border-t border-white/5 bg-slate-900/20 text-[8px] text-slate-700 flex justify-between uppercase font-black tracking-widest">
                        <span>Morgby Tactical v3.1</span>
                        <span>Encrypted Session</span>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
